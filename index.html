<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium POS System - Geraiku</title>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Date Range Picker -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.0.5/daterangepicker.min.css">
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        :root {
            --primary-color: #4361ee;
            --primary-light: #eef2ff;
            --secondary-color: #3f37c9;
            --accent-color: #4895ef;
            --dark-color: #1a1a2e;
            --light-color: #f8f9fa;
            --success-color: #10b981;
            --success-light: #d1fae5;
            --danger-color: #ef4444;
            --danger-light: #fee2e2;
            --warning-color: #f59e0b;
            --warning-light: #fef3c7;
            --info-color: #3b82f6;
            --info-light: #dbeafe;
            --gray-color: #6b7280;
            --gray-light: #f3f4f6;
            --profit-color: #8b5cf6;
            --profit-light: #f5f3ff;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --rounded-sm: 0.25rem;
            --rounded: 0.5rem;
            --rounded-lg: 0.75rem;
            --rounded-xl: 1rem;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            transition: background-color 0.3s ease;
        }
        body.dark-mode {
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        body.dark-mode .left-panel,
        body.dark-mode .right-panel,
        body.dark-mode .modal-content,
        body.dark-mode .login-container,
        body.dark-mode .header,
        body.dark-mode .tab,
        body.dark-mode .card,
        body.dark-mode .form-control,
        body.dark-mode .table th,
        body.dark-mode .dashboard-card,
        body.dark-mode .modal {
            background-color: #2d3142;
            color: #fff;
            border: 1px solid #444;
        }
        body.dark-mode .form-control,
        body.dark-mode .search-box input,
        body.dark-mode textarea,
        body.dark-mode .table th,
        body.dark-mode .btn {
            background-color: #3a3d4d;
            color: #fff;
            border-color: #555;
        }
        body.dark-mode .held-sale-item {
            background-color: #445;
            border-color: #555;
        }
        .container {
            max-width: 100%;
            margin: 0 auto;
            padding: 20px;
        }
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            padding: 0 20px;
        }
        .dashboard-card {
            background: white;
            border-radius: var(--rounded-lg);
            padding: 20px;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.2s;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
        }
        .dashboard-card-icon {
            font-size: 2.5rem;
            padding: 15px;
            border-radius: 50%;
            color: white;
        }
        .icon-sales { background-color: var(--success-color); }
        .icon-profit { background-color: var(--profit-color); }
        .icon-transactions { background-color: var(--info-color); }
        .icon-low-stock { background-color: var(--warning-color); }
        .dashboard-card-content .dashboard-card-label {
            font-size: 0.9rem;
            color: var(--gray-color);
            margin-bottom: 5px;
        }
        .dashboard-card-content .dashboard-card-value {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--dark-color);
        }
        body.dark-mode .dashboard-card-content .dashboard-card-value {
            color: #e0e0e0;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-success { background-color: var(--success-color); color: white; }
        .btn-warning { background-color: var(--warning-color); color: white; }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-info { background-color: var(--info-color); color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-sm { padding: 5px 10px; font-size: 0.875rem; }
        .header {
            background: linear-gradient(135deg, #4361ee, #3f37c9);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .main-content {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .left-panel, .right-panel {
            flex: 1;
            min-width: 300px;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: var(--shadow);
        }
        .panel-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: var(--dark-color);
        }
        body.dark-mode .panel-title {
            color: white;
        }
        .search-box {
            position: relative;
            margin-bottom: 15px;
        }
        .search-box input {
            width: 100%;
            padding: 10px 10px 10px 40px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
        }
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .table th {
            background-color: var(--gray-light);
            color: var(--gray-color);
        }
        body.dark-mode .table th {
            background-color: #3a3d4d;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #555;
            font-weight: 500;
            transition: 0.2s;
        }
        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px dashed #eee;
        }
        .cart-summary {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 2px dashed #ddd;
        }
        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .total-row {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--primary-color);
            padding-top: 10px;
            border-top: 1px solid #ddd;
            margin-top: 10px;
        }
        .held-sale-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: var(--rounded);
            margin-bottom: 10px;
            background-color: var(--primary-light);
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background: #333;
            color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1100;
            display: flex;
            align-items: center;
            transform: translateX(200%);
            transition: transform 0.3s ease;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success { background-color: var(--success-color); }
        .toast.error { background-color: var(--danger-color); }
        .toast.warning { background-color: var(--warning-color); }
        .toast.info { background-color: var(--info-color); }
        .confirmation-dialog {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1200;
            justify-content: center;
            align-items: center;
        }
        .login-container {
            max-width: 400px;
            background: #fff;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            text-align: center;
        }
        .dark-mode-toggle {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.5rem;
            color: #4361ee;
            cursor: pointer;
            z-index: 100;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 20px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        .report-chart {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
        }
        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            .main-content {
                flex-direction: column;
            }
        }
    </style>
</head>
<body oncontextmenu="showAdminMenu(event)">
    <!-- Dark Mode Toggle -->
    <div class="dark-mode-toggle" id="darkModeToggle"><i class="fas fa-moon"></i></div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <i class="fas fa-info-circle"></i>
        <span id="toast-message">Notification</span>
    </div>

    <!-- Confirmation Dialog -->
    <div id="confirmationDialog" class="confirmation-dialog">
        <div class="modal-content">
            <h4 id="confirmationMessage">Apakah Anda yakin?</h4>
            <div style="margin-top:20px;display:flex;justify-content:center;gap:10px;">
                <button id="confirmCancel" class="btn btn-secondary">Batal</button>
                <button id="confirmOk" class="btn btn-danger">Ya, Lanjutkan</button>
            </div>
        </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal" style="display:flex;">
        <div class="login-container">
            <div class="login-logo"><i class="fas fa-cash-register" style="font-size:3rem;color:#4361ee;"></i></div>
            <h2 class="login-title">Premium POS - Geraiku</h2>
            <form id="loginForm">
                <div class="form-floating" style="margin-bottom:15px;position:relative;">
                    <input type="text" id="cashierId" placeholder="ID Kasir" required>
                    <label>ID Kasir</label>
                </div>
                <div class="form-floating" style="margin-bottom:15px;position:relative;">
                    <input type="password" id="cashierPin" placeholder="PIN" required maxlength="4" inputmode="numeric">
                    <label>PIN</label>
                </div>
                <button type="submit" class="btn btn-primary btn-block">
                    <span id="loginBtnText">Login</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" style="display:none;">
        <div class="dashboard-cards">
            <div class="dashboard-card">
                <div class="dashboard-card-icon icon-sales"><i class="fas fa-dollar-sign"></i></div>
                <div class="dashboard-card-content">
                    <div class="dashboard-card-label">Penjualan Hari Ini</div>
                    <div class="dashboard-card-value" id="todaySales">Rp 0</div>
                </div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-card-icon icon-profit"><i class="fas fa-chart-line"></i></div>
                <div class="dashboard-card-content">
                    <div class="dashboard-card-label">Laba Hari Ini</div>
                    <div class="dashboard-card-value" id="todayProfit">Rp 0</div>
                </div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-card-icon icon-transactions"><i class="fas fa-shopping-cart"></i></div>
                <div class="dashboard-card-content">
                    <div class="dashboard-card-label">Transaksi Hari Ini</div>
                    <div class="dashboard-card-value" id="todayTransactions">0</div>
                </div>
            </div>
            <div class="dashboard-card">
                <div class="dashboard-card-icon icon-low-stock"><i class="fas fa-box-open"></i></div>
                <div class="dashboard-card-content">
                    <div class="dashboard-card-label">Stok Rendah</div>
                    <div class="dashboard-card-value" id="lowStockItems">0</div>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="header">
                <div>
                    <h1 id="storeName">Premium POS System</h1>
                    <p id="storeAddress">Jl. Contoh No. 123, Kota Contoh</p>
                </div>
                <div class="header-info">
                    <p id="currentDate">Senin, 1 Januari 2023</p>
                    <p>Kasir: <span id="loggedInCashier">John Doe</span> | <a href="#" id="logoutBtn" style="color:white;">Logout</a></p>
                    <p>Shift: <span id="shiftStatus" class="badge">Belum Dimulai</span></p>
                </div>
            </div>

            <div class="main-content">
                <!-- Left Panel -->
                <div class="left-panel">
                    <h2 class="panel-title">Produk</h2>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="productSearch" placeholder="Cari produk...">
                    </div>
                    <div class="form-group">
                        <label for="productCategory">Kategori</label>
                        <select id="productCategory" class="form-control">
                            <option value="all">Semua Kategori</option>
                        </select>
                    </div>
                    <div id="productList" class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Nama</th>
                                    <th>Harga</th>
                                    <th>Stok</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="productListBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Right Panel -->
                <div class="right-panel">
                    <h2 class="panel-title">Transaksi</h2>
                    <div class="tabs">
                        <div class="tab active" data-tab="cart">Keranjang</div>
                        <div class="tab" data-tab="customer">Pelanggan</div>
                        <div class="tab" data-tab="payment">Pembayaran</div>
                    </div>

                    <!-- Cart Tab -->
                    <div class="tab-content active" id="cartTab">
                        <div id="cartItems">
                            <p id="emptyCart">Keranjang kosong</p>
                        </div>
                        <div class="cart-summary">
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="cartSubtotal">Rp 0</span>
                            </div>
                            <div class="summary-row">
                                <span>Diskon:</span>
                                <span id="cartDiscount">Rp 0</span>
                            </div>
                            <div class="summary-row">
                                <span>Pajak (10%):</span>
                                <span id="cartTax">Rp 0</span>
                            </div>
                            <div class="summary-row total-row">
                                <span>Total:</span>
                                <span id="cartTotal">Rp 0</span>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button id="holdSaleBtn" class="btn btn-warning"><i class="fas fa-pause"></i> Tahan</button>
                            <button id="nextToCustomer" class="btn btn-primary">Lanjut <i class="fas fa-arrow-right"></i></button>
                        </div>
                        <div id="heldSalesSection">
                            <h4>Transaksi Ditahan</h4>
                            <div id="heldSalesList"></div>
                        </div>
                    </div>

                    <!-- Customer Tab -->
                    <div class="tab-content" id="customerTab">
                        <div class="form-group">
                            <label>Tipe Pelanggan</label>
                            <select id="customerType">
                                <option value="walkin">Pelanggan Biasa</option>
                                <option value="member">Member</option>
                            </select>
                        </div>
                        <div id="memberFields" style="display:none;">
                            <div class="form-group">
                                <label>ID Member</label>
                                <div style="display:flex;">
                                    <input type="text" id="memberId" placeholder="Masukkan ID Member">
                                    <button id="searchMember" class="btn btn-info">Cari</button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Diskon Member (%)</label>
                                <input type="number" id="memberDiscount" value="10" min="0" max="100">
                            </div>
                        </div>
                        <div id="customerFields" style="display:none;">
                            <div class="form-group">
                                <label>Nama Pelanggan</label>
                                <input type="text" id="customerName" placeholder="Masukkan nama">
                            </div>
                            <div class="form-group">
                                <label>No. Telepon</label>
                                <input type="tel" id="customerPhone" placeholder="0812...">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="customerEmail" placeholder="email@domain.com">
                            </div>
                        </div>
                        <div class="buttons">
                            <button id="backToCart" class="btn btn-warning">Kembali</button>
                            <button id="nextToPayment" class="btn btn-primary">Lanjut ke Pembayaran</button>
                        </div>
                    </div>

                    <!-- Payment Tab -->
                    <div class="tab-content" id="paymentTab">
                        <div class="cart-summary">
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span id="paymentSubtotal">Rp 0</span>
                            </div>
                            <div class="summary-row">
                                <span>Diskon:</span>
                                <span id="paymentDiscount">Rp 0</span>
                            </div>
                            <div class="summary-row">
                                <span>Pajak:</span>
                                <span id="paymentTax">Rp 0</span>
                            </div>
                            <div class="summary-row total-row">
                                <span>Total:</span>
                                <span id="paymentTotal">Rp 0</span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Jumlah Pembayaran</label>
                            <input type="number" id="paymentAmount" placeholder="Masukkan jumlah">
                        </div>
                        <div class="payment-methods">
                            <label>Metode:</label>
                            <div><input type="radio" name="paymentMethod" value="cash" checked> <label>Tunai</label></div>
                            <div><input type="radio" name="paymentMethod" value="transfer"> Transfer</div>
                            <div><input type="radio" name="paymentMethod" value="ewallet"> E-Wallet</div>
                        </div>
                        <div class="buttons">
                            <button id="backToCustomer" class="btn btn-warning">Kembali</button>
                            <button id="completePayment" class="btn btn-success"><i class="fas fa-print"></i> Selesaikan & Cetak</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Menu -->
    <div id="adminMenu" class="modal">
        <div class="modal-content">
            <h3>Admin Panel</h3>
            <div style="margin:15px 0;">
                <input type="password" id="adminPassword" placeholder="Masukkan password admin" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
                <button class="btn btn-secondary" onclick="closeAdminMenu()">Batal</button>
                <button class="btn btn-primary" onclick="enterAdminMode()">Masuk</button>
            </div>
        </div>
    </div>

    <!-- Laporan Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <h3>Laporan Penjualan</h3>
            <div class="form-group">
                <label>Periode</label>
                <input type="text" id="reportRange" class="form-control" readonly>
            </div>
            <div class="report-chart">
                <canvas id="salesChart"></canvas>
            </div>
            <div style="margin:15px 0;display:flex;gap:10px;">
                <button class="btn btn-info" onclick="exportToExcel()"><i class="fas fa-file-excel"></i> Export Excel</button>
                <button class="btn btn-danger" onclick="exportToPDF()"><i class="fas fa-file-pdf"></i> Export PDF</button>
            </div>
            <button class="btn btn-secondary" onclick="closeReportModal()">Tutup</button>
        </div>
    </div>

    <!-- Hidden Receipt Template -->
    <div id="receiptTemplate" style="display:none;">
        <div style="font-family:monospace; font-size:12px; text-align:center; width:80mm;">
            <h3 id="receiptStoreName">Toko Geraiku</h3>
            <p id="receiptStoreAddress">Jl. Digital Raya No. 1</p>
            <p id="receiptDate"></p>
            <hr>
            <div id="receiptItems"></div>
            <hr>
            <div>Subtotal: <span id="receiptSubtotal">0</span></div>
            <div>Diskon: <span id="receiptDiscount">0</span></div>
            <div>Pajak: <span id="receiptTax">0</span></div>
            <div>Total: <span id="receiptTotal">0</span></div>
            <div>Bayar: <span id="receiptPaid">0</span></div>
            <div>Kembali: <span id="receiptChange">0</span></div>
            <p>Terima kasih!</p>
        </div>
    </div>

    <!-- Script Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/locale/id.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/3.0.5/daterangepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/davidshimjs/qrcodejs/qrcode.min.js"></script>

    <!-- Main JavaScript -->
    <script>
        moment.locale('id');
        const ADMIN_PASSWORD = "Geraiku.12345";
        let currentCart = { items: [], customer: null, discount: 0, tax: 0, subtotal: 0, total: 0, totalCost: 0, profit: 0 };
        let currentShift = null;
        let currentCashier = null;
        let heldSales = [];
        let salesChart = null;
        let products = [], categories = [], customers = [], cashiers = [], transactions = [], settings = {};

        const STORAGE_KEYS = {
            PRODUCTS: 'pos_premium_products',
            CATEGORIES: 'pos_premium_categories',
            CUSTOMERS: 'pos_premium_customers',
            CASHIERS: 'pos_premium_cashiers',
            TRANSACTIONS: 'pos_premium_transactions',
            SETTINGS: 'pos_premium_settings',
            CURRENT_CASHIER: 'pos_premium_current_cashier',
            HELD_SALES: 'pos_premium_held_sales',
            CURRENT_SHIFT: 'pos_premium_current_shift',
        };

        function showToast(message, type = 'info', duration = 3000) {
            const t = $("#toast");
            const s = $("#toast-message");
            t.removeClass("success error warning info").addClass(type);
            s.text(message);
            t.addClass("show");
            setTimeout(() => t.removeClass("show"), duration);
        }

        function showConfirmation(message, callback, btnText = "Ya, Lanjutkan") {
            const t = $("#confirmationMessage");
            const o = $("#confirmationDialog");
            const n = $("#confirmOk");
            const a = $("#confirmCancel");
            t.text(message);
            n.text(btnText);
            o.css("display", "flex");
            n.off("click").on("click", () => { o.hide(); callback && callback(true); });
            a.off("click").on("click", () => { o.hide(); callback && callback(false); });
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat("id-ID", { style: "currency", currency: "IDR", minimumFractionDigits: 0 }).format(amount || 0);
        }

        function saveData(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (e) {
                showToast("Storage penuh.", "error");
            }
        }

        function loadData() {
            try {
                products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS)) || [];
                categories = JSON.parse(localStorage.getItem(STORAGE_KEYS.CATEGORIES)) || [];
                customers = JSON.parse(localStorage.getItem(STORAGE_KEYS.CUSTOMERS)) || [];
                cashiers = JSON.parse(localStorage.getItem(STORAGE_KEYS.CASHIERS)) || [];
                transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS)) || [];
                settings = JSON.parse(localStorage.getItem(STORAGE_KEYS.SETTINGS)) || {};
                heldSales = JSON.parse(localStorage.getItem(STORAGE_KEYS.HELD_SALES)) || [];
                currentCashier = JSON.parse(localStorage.getItem(STORAGE_KEYS.CURRENT_CASHIER)) || null;
                currentShift = JSON.parse(localStorage.getItem(STORAGE_KEYS.CURRENT_SHIFT)) || null;
            } catch (e) {
                showToast("Gagal memuat data.", "error");
            }
        }

        function initializeDefaultData() {
            loadData();
            if (cashiers.length === 0) {
                cashiers = [
                    { id: 'K001', name: 'Admin', pin: '1234', status: 'active' },
                    { id: 'K002', name: 'Kasir 1', pin: '1111', status: 'active' },
                ];
                saveData(STORAGE_KEYS.CASHIERS, cashiers);
            }
            if (Object.keys(settings).length === 0) {
                settings = {
                    storeName: "Toko Geraiku",
                    storeAddress: "Jl. Digital Raya No. 1",
                    storePhone: "081234567890",
                    taxRate: 10,
                };
                saveData(STORAGE_KEYS.SETTINGS, settings);
            }
            if (categories.length === 0) {
                categories = [
                    { id: 'C001', name: 'Makanan Ringan' },
                    { id: 'C002', name: 'Minuman Dingin' },
                ];
                saveData(STORAGE_KEYS.CATEGORIES, categories);
            }
            if (products.length === 0) {
                products = [
                    { id: 'P001', barcode: '8992761134015', name: 'Chitato Sapi Panggang', categoryId: 'C001', costPrice: 7500, price: 10000, stock: 50 },
                    { id: 'P002', barcode: '8996001300032', name: 'Coca-Cola 390ml', categoryId: 'C002', costPrice: 3500, price: 5000, stock: 100 },
                ];
                saveData(STORAGE_KEYS.PRODUCTS, products);
            }
        }

        function updateAllUI() {
            updateCurrentDate();
            updateDashboard();
            loadProducts();
            updateCategoryDropdowns();
            updateCart();
            updateHeldSalesList();
            updateShiftStatus();
            $('#storeName').text(settings.storeName);
            $('#storeAddress').text(settings.storeAddress);
            $('#loggedInCashier').text(currentCashier?.name || 'Unknown');
        }

        function updateCurrentDate() {
            $('#currentDate').text(moment().format('dddd, D MMMM YYYY, HH:mm'));
        }

        function updateDashboard() {
            const today = moment().startOf('day');
            const todayTransactions = transactions.filter(t => moment(t.date).isSameOrAfter(today));
            const todaySales = todayTransactions.reduce((sum, t) => sum + t.total, 0);
            const todayProfit = todayTransactions.reduce((sum, t) => sum + t.profit, 0);
            const lowStockItems = products.filter(p => p.stock <= 5 && p.stock > 0).length;
            $('#todaySales').text(formatCurrency(todaySales));
            $('#todayProfit').text(formatCurrency(todayProfit));
            $('#todayTransactions').text(todayTransactions.length);
            $('#lowStockItems').text(lowStockItems);
        }

        function updateCategoryDropdowns() {
            const select = $('#productCategory');
            select.empty().append('<option value="all">Semua Kategori</option>');
            categories.forEach(cat => select.append(`<option value="${cat.id}">${cat.name}</option>`));
        }

        function loadProducts(searchTerm = '', categoryId = 'all') {
            let filtered = products;
            if (searchTerm) filtered = filtered.filter(p => p.name.toLowerCase().includes(searchTerm.toLowerCase()) || p.barcode.includes(searchTerm));
            if (categoryId !== 'all') filtered = filtered.filter(p => p.categoryId === categoryId);

            const body = $('#productListBody'); body.empty();
            if (filtered.length === 0) {
                body.html('<tr><td colspan="4">Produk tidak ditemukan</td></tr>');
            } else {
                filtered.forEach(p => {
                    const stockClass = p.stock <= 5 ? 'text-danger' : p.stock <= 10 ? 'text-warning' : '';
                    body.append(`
                        <tr>
                            <td>${p.name}</td>
                            <td>${formatCurrency(p.price)}</td>
                            <td class="${stockClass}">${p.stock}</td>
                            <td><button class="btn btn-success btn-sm add-to-cart" data-id="${p.id}" ${p.stock <= 0 ? 'disabled' : ''}><i class="fas fa-cart-plus"></i></button></td>
                        </tr>
                    `);
                });
            }
        }

        function updateCart() {
            const container = $('#cartItems');
            if (currentCart.items.length === 0) {
                container.html('<p id="emptyCart">Keranjang kosong</p>');
            } else {
                container.empty();
                currentCart.items.forEach((item, index) => {
                    container.append(`
                        <div class="cart-item">
                            <div>
                                <strong>${item.name}</strong> x${item.qty}
                                <br>Rp ${(item.price * item.qty).toLocaleString()}
                            </div>
                            <button class="btn btn-danger btn-sm remove-item" data-index="${index}"><i class="fas fa-trash"></i></button>
                        </div>
                    `);
                });
            }
            calculateTotals();
        }

        function calculateTotals() {
            const subtotal = currentCart.items.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const discount = currentCart.discount || 0;
            const taxRate = settings.taxRate || 10;
            const tax = (subtotal - discount) * (taxRate / 100);
            const total = subtotal - discount + tax;

            currentCart.subtotal = subtotal;
            currentCart.tax = tax;
            currentCart.total = total;
            currentCart.profit = total - currentCart.items.reduce((sum, item) => sum + (item.costPrice * item.qty), 0);

            $('#cartSubtotal, #paymentSubtotal').text(formatCurrency(subtotal));
            $('#cartDiscount, #paymentDiscount').text(formatCurrency(discount));
            $('#cartTax, #paymentTax').text(formatCurrency(tax));
            $('#cartTotal, #paymentTotal').text(formatCurrency(total));
        }

        function updateHeldSalesList() {
            const list = $('#heldSalesList'); list.empty();
            heldSales.forEach((sale, i) => {
                list.append(`
                    <div class="held-sale-item">
                        <span>Transaksi ${i+1} - ${formatCurrency(sale.total)}</span>
                        <button class="btn btn-info btn-sm resume-sale" data-index="${i}">Lanjut</button>
                    </div>
                `);
            });
        }

        function updateShiftStatus() {
            const status = currentShift ? 'Aktif' : 'Belum Dimulai';
            $('#shiftStatus').text(status);
        }

        $(document).ready(function() {
            initializeDefaultData();

            if (!currentCashier) {
                $('#loginModal').show();
                $('#mainApp').hide();
            } else {
                $('#loginModal').hide();
                $('#mainApp').show();
                updateAllUI();
            }

            $('#cashierId').focus();
            setInterval(updateCurrentDate, 60000);

            // Login
            $('#loginForm').on('submit', function(e) {
                e.preventDefault();
                const id = $('#cashierId').val();
                const pin = $('#cashierPin').val();
                const cashier = cashiers.find(c => c.id === id && c.pin === pin);
                if (cashier) {
                    currentCashier = cashier;
                    saveData(STORAGE_KEYS.CURRENT_CASHIER, cashier);
                    $('#loginModal').hide();
                    $('#mainApp').show();
                    updateAllUI();
                    showToast("Login berhasil!", "success");
                } else {
                    showToast("ID atau PIN salah!", "error");
                }
            });

            // Logout
            $('#logoutBtn').on('click', function(e) {
                e.preventDefault();
                showConfirmation("Yakin ingin logout?", (confirm) => {
                    if (confirm) {
                        currentCashier = null;
                        localStorage.removeItem(STORAGE_KEYS.CURRENT_CASHIER);
                        $('#mainApp').hide();
                        $('#loginModal').show();
                        $('#cashierId').val('').focus();
                        showToast("Logout berhasil", "info");
                    }
                });
            });

            // Tab Navigation
            $('.tab').on('click', function() {
                $('.tab').removeClass('active');
                $('.tab-content').removeClass('active');
                $(this).addClass('active');
                $($(this).data('tab') + 'Tab').addClass('active');
            });

            // Search & Filter
            $('#productSearch').on('input', function() {
                loadProducts($(this).val(), $('#productCategory').val());
            });
            $('#productCategory').on('change', function() {
                loadProducts($('#productSearch').val(), $(this).val());
            });

            // Add to Cart
            $(document).on('click', '.add-to-cart', function() {
                const id = $(this).data('id');
                const product = products.find(p => p.id === id);
                if (product.stock <= 0) return showToast("Stok habis!", "warning");
                const existing = currentCart.items.find(i => i.id === id);
                if (existing) {
                    existing.qty += 1;
                } else {
                    currentCart.items.push({ ...product, qty: 1 });
                }
                product.stock -= 1;
                saveData(STORAGE_KEYS.PRODUCTS, products);
                updateCart();
                showToast(`${product.name} ditambahkan`, "success");
            });

            // Remove from Cart
            $(document).on('click', '.remove-item', function() {
                const index = $(this).data('index');
                const item = currentCart.items[index];
                const product = products.find(p => p.id === item.id);
                product.stock += item.qty;
                currentCart.items.splice(index, 1);
                saveData(STORAGE_KEYS.PRODUCTS, products);
                updateCart();
            });

            // Hold Sale
            $('#holdSaleBtn').on('click', function() {
                if (currentCart.items.length === 0) return showToast("Keranjang kosong!", "warning");
                heldSales.push({ ...currentCart });
                saveData(STORAGE_KEYS.HELD_SALES, heldSales);
                currentCart = { items: [], customer: null, discount: 0, total: 0 };
                updateCart();
                updateHeldSalesList();
                showToast("Transaksi ditahan", "info");
            });

            // Resume Held Sale
            $(document).on('click', '.resume-sale', function() {
                const index = $(this).data('index');
                currentCart = heldSales[index];
                heldSales.splice(index, 1);
                saveData(STORAGE_KEYS.HELD_SALES, heldSales);
                updateCart();
                updateHeldSalesList();
                $('.tab').removeClass('active');
                $('#cartTab').addClass('active');
                showToast("Transaksi dilanjutkan", "success");
            });

            // Customer Type Change
            $('#customerType').on('change', function() {
                const type = $(this).val();
                $('#memberFields, #customerFields').hide();
                if (type === 'member') $('#memberFields').show();
                else $('#customerFields').show();
            });

            // Next to Customer
            $('#nextToCustomer').on('click', function() {
                $('.tab').removeClass('active');
                $('#customerTab').addClass('active');
            });

            // Back to Cart
            $('#backToCart').on('click', function() {
                $('.tab').removeClass('active');
                $('#cartTab').addClass('active');
            });

            // Next to Payment
            $('#nextToPayment').on('click', function() {
                const type = $('#customerType').val();
                let customer = { type };
                if (type === 'member') {
                    customer.id = $('#memberId').val();
                    customer.discount = parseFloat($('#memberDiscount').val()) || 0;
                } else {
                    customer.name = $('#customerName').val();
                    customer.phone = $('#customerPhone').val();
                    customer.email = $('#customerEmail').val();
                }
                currentCart.customer = customer;
                if (customer.discount) {
                    currentCart.discount = currentCart.subtotal * (customer.discount / 100);
                }
                calculateTotals();
                $('.tab').removeClass('active');
                $('#paymentTab').addClass('active');
            });

            // Complete Payment
            $('#completePayment').on('click', function() {
                const paid = parseFloat($('#paymentAmount').val());
                const total = currentCart.total;
                if (isNaN(paid) || paid < total) return showToast("Pembayaran kurang!", "error");

                const change = paid - total;
                const transaction = {
                    id: 'TRX' + Date.now(),
                    date: new Date().toISOString(),
                    cashier: currentCashier.id,
                    customer: currentCart.customer,
                    items: [...currentCart.items],
                    subtotal: currentCart.subtotal,
                    discount: currentCart.discount,
                    tax: currentCart.tax,
                    total: total,
                    paid: paid,
                    change: change,
                    profit: currentCart.profit,
                    method: $('input[name="paymentMethod"]:checked').val()
                };

                transactions.push(transaction);
                saveData(STORAGE_KEYS.TRANSACTIONS, transactions);

                // Print Receipt
                printReceipt(transaction);

                // Reset
                currentCart = { items: [], customer: null, discount: 0, total: 0 };
                updateCart();
                $('.tab').removeClass('active');
                $('#cartTab').addClass('active');
                showToast("Transaksi berhasil!", "success");
            });

            // Dark Mode Toggle
            $('#darkModeToggle').on('click', function() {
                $('body').toggleClass('dark-mode');
                const icon = $(this).find('i');
                if ($('body').hasClass('dark-mode')) {
                    icon.removeClass('fa-moon').addClass('fa-sun');
                } else {
                    icon.removeClass('fa-sun').addClass('fa-moon');
                }
            });

            // Auto start shift
            if (currentCashier && !currentShift) {
                currentShift = { start: new Date(), cashier: currentCashier.id };
                saveData(STORAGE_KEYS.CURRENT_SHIFT, currentShift);
                updateShiftStatus();
            }

            // Initialize Date Range Picker
            $('#reportRange').daterangepicker({
                startDate: moment().subtract(29, 'days'),
                endDate: moment(),
                ranges: {
                    'Hari Ini': [moment(), moment()],
                    'Kemarin': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    '7 Hari Terakhir': [moment().subtract(6, 'days'), moment()],
                    '30 Hari Terakhir': [moment().subtract(29, 'days'), moment()],
                    'Bulan Ini': [moment().startOf('month'), moment().endOf('month')],
                    'Bulan Lalu': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                },
                locale: { format: 'DD/MM/YYYY' }
            });
        });

        function showAdminMenu(e) {
            e.preventDefault();
            $('#adminMenu').show();
        }

        function closeAdminMenu() {
            $('#adminMenu').hide();
            $('#adminPassword').val('');
        }

        function enterAdminMode() {
            const pass = $('#adminPassword').val();
            if (pass === ADMIN_PASSWORD) {
                $('#adminMenu').hide();
                $('#adminPassword').val('');
                showReportModal();
            } else {
                showToast("Password salah!", "error");
            }
        }

        function showReportModal() {
            $('#reportModal').show();
            generateSalesChart();
        }

        function closeReportModal() {
            $('#reportModal').hide();
            if (salesChart) salesChart.destroy();
        }

        function generateSalesChart() {
            const range = $('#reportRange').data('daterangepicker');
            const start = range.startDate;
            const end = range.endDate;
            const filtered = transactions.filter(t => moment(t.date).isBetween(start, end, null, '[]'));
            const daily = {};
            filtered.forEach(t => {
                const date = moment(t.date).format('YYYY-MM-DD');
                daily[date] = (daily[date] || 0) + t.total;
            });
            const labels = Object.keys(daily).sort();
            const data = labels.map(date => daily[date]);

            if (salesChart) salesChart.destroy();
            const ctx = document.getElementById('salesChart').getContext('2d');
            salesChart = new Chart(ctx, {
                type: 'bar',
                 {
                    labels: labels,
                    datasets: [{
                        label: 'Penjualan (Rp)',
                         data,
                        backgroundColor: '#4361ee'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function exportToExcel() {
            const range = $('#reportRange').data('daterangepicker');
            const start = range.startDate;
            const end = range.endDate;
            const filtered = transactions.filter(t => moment(t.date).isBetween(start, end, null, '[]'));

            const data = filtered.map(t => ({
                ID: t.id,
                Tanggal: moment(t.date).format('DD/MM/YYYY HH:mm'),
                Kasir: cashiers.find(c => c.id === t.cashier)?.name || 'Unknown',
                Total: t.total,
                Metode: t.method,
                Item: t.items.map(i => `${i.name} x${i.qty}`).join(', ')
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Laporan");
            XLSX.writeFile(wb, `Laporan_Penjualan_${start.format('DDMMYYYY')}_to_${end.format('DDMMYYYY')}.xlsx`);
        }

        function exportToPDF() {
            const element = document.getElementById('salesChart');
            html2pdf().from(element).save('Laporan_Penjualan.pdf');
        }

        function printReceipt(transaction) {
            $('#receiptStoreName').text(settings.storeName);
            $('#receiptStoreAddress').text(settings.storeAddress);
            $('#receiptDate').text(moment(transaction.date).format('DD/MM/YYYY HH:mm'));
            $('#receiptItems').html('');
            transaction.items.forEach(item => {
                $('#receiptItems').append(`<div>${item.name} x${item.qty} @${formatCurrency(item.price)}</div>`);
            });
            $('#receiptSubtotal').text(formatCurrency(transaction.subtotal));
            $('#receiptDiscount').text(formatCurrency(transaction.discount));
            $('#receiptTax').text(formatCurrency(transaction.tax));
            $('#receiptTotal').text(formatCurrency(transaction.total));
            $('#receiptPaid').text(formatCurrency(transaction.paid));
            $('#receiptChange').text(formatCurrency(transaction.change));

            const receipt = document.getElementById('receiptTemplate').innerHTML;
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Struk</title></head><body>');
            printWindow.document.write(receipt);
            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }
    </script>
</body>
</html>
